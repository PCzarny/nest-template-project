name: Deploy to Cloud Run

env:
  SERVICE_NAME: nest-template-project
  REPOSITORY_NAME: nest-template-project
  GCP_REGION: europe-west1
  NODE_VERSION: 24.11
  YARN_CACHE_FOLDER: .yarn/cache

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  install:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Cache node_modules
        uses: actions/cache/save@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}

  test_unit:
    runs-on: ubuntu-latest
    needs: install

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache/restore@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Run unit tests
        run: yarn test

      - name: Run test coverage
        run: yarn test:cov

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-umbrella

  test_e2e:
    runs-on: ubuntu-latest
    needs: install

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      mongodb:
        image: mongo:7-jammy
        env:
          MONGO_INITDB_ROOT_USERNAME: test_user
          MONGO_INITDB_ROOT_PASSWORD: test_password
          MONGO_INITDB_DATABASE: test_db
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.runCommand({ping: 1})'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache/restore@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Setup test database
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        # run: yarn prisma migrate deploy || yarn prisma db push
        run: yarn prisma migrate deploy

      - name: Generate Prisma client
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: yarn prisma generate
      - name: Run e2e tests
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          MONGODB_URI: mongodb://test_user:test_password@localhost:27017/test_db?authSource=admin
          NODE_ENV: test
        run: yarn test:e2e
        # Add test coverage for e2e

  lint:
    runs-on: ubuntu-latest
    needs: install

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Restore node_modules
        uses: actions/cache/restore@v3
        with:
          path: |
            node_modules
            .yarn/cache
          key: ${{ runner.os }}-yarn-${{ hashFiles('yarn.lock') }}

      - name: Generate Prisma Client
        run: yarn prisma generate
        env:
          DATABASE_URL: postgresql://dummy:dummy@localhost:5432/dummy

      - name: Run linter
        run: yarn lint

  # DISABLE AS OUR POSTGRES SERVER DON'T PROVIDE IPv4
  # migrate:
  #   runs-on: ubuntu-latest

  #   needs: install-node

  #   steps:
  #     - uses: actions/checkout@v2

  #     - name: Setup Nodejs
  #       uses: actions/setup-node@v2
  #       with:
  #         node-version: ${{ env.NODE_VERSION }}

  #     - name: Install
  #       run: yarn install

  #     - name: Deploy Migrations
  #       run: yarn prisma migrate deploy
  #       env:
  #         DATABASE_URL: ${{ secrets.DATABASE_URL }}

  dockerize-and-deploy:
    name: Build, and Deploy to Google Cloud Run
    runs-on: ubuntu-latest
    needs: [test_unit, test_e2e, lint]

    # Deploy only on push to main branch
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Google Cloud Auth
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'
          project_id: ${{ vars.GCP_PROJECT_ID }}

      - name: Set up Cloud SDK
        uses: 'google-github-actions/setup-gcloud@v3'

      - name: Authenticate Docker to Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Set image name
        id: image
        run: |
          IMAGE_NAME="${{ env.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/${{ env.REPOSITORY_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}"
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "Image will be: ${IMAGE_NAME}"

      - name: Build the Docker image
        run: |
          docker build \
            --build-arg DATABASE_URL="${{ secrets.DATABASE_URL }}" \
            -t ${{ env.IMAGE_NAME }} \
            -f Dockerfile .

      - name: Push to Registry
        run: docker push ${{ env.IMAGE_NAME }}

      - name: Deploy to Cloud Run
        run: |
          echo SERVICE_NAME $SERVICE_NAME
          gcloud run deploy $SERVICE_NAME \
            --image ${{ env.IMAGE_NAME }} \
            --platform managed \
            --region ${{ env.GCP_REGION }} \
            --port=3000 \
            --allow-unauthenticated \
            --set-env-vars="NODE_ENV=production" \
            --set-secrets="DATABASE_URL=DATABASE_URL:latest,JWT_SECRET=JWT_SECRET:latest,MONGO_URI=MONGO_URI:latest" \
            --service-account=cloud-run-sa@${{ vars.GCP_PROJECT_ID }}.iam.gserviceaccount.com

      - name: Output service URL
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.GCP_REGION }} \
            --format='value(status.url)')
          echo "Service deployed to: ${SERVICE_URL}"
